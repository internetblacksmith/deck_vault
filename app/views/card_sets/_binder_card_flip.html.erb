<%
  quantity = card.collection_card&.quantity.to_i
  foil_quantity = card.collection_card&.foil_quantity.to_i
  is_owned = quantity > 0 || foil_quantity > 0
  is_dfc = card.double_faced?
  card_uid = "binder-card-#{card.id}"
%>
<% unless is_owned %>
<style>
  #<%= card_uid %>:hover .binder-card-front { opacity: 1 !important; }
  #<%= card_uid %>:hover .binder-card-img { filter: none !important; }
</style>
<% end %>
<div data-controller="binder-card" 
     id="<%= card_uid %>"
     data-card-id="<%= card.id %>"
     data-binder-card-card-set-id-value="<%= card_set.id %>"
     data-binder-card-is-dfc-value="<%= is_dfc %>"
     data-binder-card-front-image-value="<%= card.image_path.present? ? "/#{card.image_path}" : '/card_placeholder.webp' %>"
     data-binder-card-back-image-value="<%= is_dfc && card.back_image_path.present? ? "/#{card.back_image_path}" : '' %>"
     data-card-name="<%= card.name.downcase %>"
     data-card-number="<%= card.collector_number.downcase %>"
     data-card-type="<%= card.type_line&.downcase %>"
     style="display:flex;flex-direction:column;gap:4px;">
  
  <!-- Control Bar (above card) -->
  <div style="display:flex;justify-content:space-between;align-items:center;padding:0 2px;">
    <!-- Left: Flip button (DFC only) + Quantity badges -->
    <div style="display:flex;align-items:center;gap:4px;">
      <% if is_dfc %>
        <button data-action="click->binder-card#flipCard"
                data-binder-card-target="flipButton"
                style="width:22px;height:22px;border-radius:3px;background:#333;border:1px solid #444;color:#fff;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;"
                onmouseover="this.style.background='#444'"
                onmouseout="this.style.background=this.dataset.showing === 'back' ? '#2864b4' : '#333'"
                title="Flip card (double-faced)"
                data-showing="front">
          &#8644;
        </button>
      <% end %>
      <% if is_owned %>
        <div class="quantity-badges" data-binder-card-target="badges" style="display:flex;gap:3px;">
          <% if quantity > 0 %>
            <div data-binder-card-target="normalBadge" style="background:#1a3a1a;color:#4f8;padding:1px 5px;border-radius:3px;font-size:10px;font-weight:600;border:1px solid #2a4a2a;">
              x<%= quantity %>
            </div>
          <% end %>
          <% if foil_quantity > 0 %>
            <div data-binder-card-target="foilBadge" style="background:linear-gradient(135deg, #2a2a3a 0%, #1a1a2a 100%);color:#c9f;padding:1px 5px;border-radius:3px;font-size:10px;font-weight:600;border:1px solid #3a3a4a;">
              x<%= foil_quantity %>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="quantity-badges" data-binder-card-target="badges" style="display:flex;gap:3px;"></div>
      <% end %>
    </div>
    
    <!-- Right: Edit button -->
    <button data-action="click->binder-card#toggleEditor"
            data-binder-card-target="editButton"
            style="width:22px;height:22px;border-radius:3px;background:#333;border:1px solid #444;color:#fff;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;"
            onmouseover="this.style.background='#444'"
            onmouseout="this.style.background='#333'"
            title="Edit quantities">
      &#9881;
    </button>
  </div>

  <!-- Card Container -->
  <div data-binder-card-target="card" style="position:relative;aspect-ratio:5/7;">
    
    <!-- Card Image -->
    <div data-binder-card-target="front"
         class="binder-card-front"
         style="position:absolute;inset:0;border-radius:4px;overflow:hidden;background:#222;<%= 'opacity:0.5;transition:opacity 0.2s;' unless is_owned %>">
      <img data-binder-card-target="cardImage"
           src="<%= card.image_path.present? ? "/#{card.image_path}" : '/card_placeholder.webp' %>" 
           alt="<%= card.name %>" 
           class="binder-card-img"
           style="width:100%;height:100%;object-fit:cover;<%= 'filter:grayscale(100%);transition:filter 0.2s;' unless is_owned %>" 
           onerror="this.src='/card_placeholder.webp'">
    </div>
    
    <!-- Card number & position badges (on card) -->
    <div style="position:absolute;bottom:4px;left:4px;background:rgba(0,0,0,0.9);color:#fff;padding:3px 7px;border-radius:3px;font-size:10px;font-weight:500;">
      <%= formatted_collector_number(card.collector_number, card_set.code) %>
    </div>
    <div style="position:absolute;bottom:4px;right:4px;background:rgba(0,0,0,0.75);color:#999;padding:3px 6px;border-radius:3px;font-size:9px;">
      #<%= position %>
    </div>
    
    <!-- Editor Overlay (shown/hidden, not flipped) -->
    <div data-binder-card-target="editor"
         style="display:none;position:absolute;inset:0;border-radius:4px;background:rgba(30,30,30,0.95);padding:10px;flex-direction:column;justify-content:center;">
      
      <!-- Close Button -->
      <button data-action="click->binder-card#toggleEditor"
              style="position:absolute;top:4px;right:4px;width:22px;height:22px;border-radius:50%;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;font-size:12px;line-height:1;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;"
              onmouseover="this.style.background='rgba(255,255,255,0.2)'"
              onmouseout="this.style.background='rgba(255,255,255,0.1)'"
              title="Close">
        &times;
      </button>
      
      <div style="color:#fff;font-size:10px;font-weight:500;margin-bottom:6px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
        <%= card.name %>
      </div>
      
      <div style="color:#666;font-size:9px;text-align:center;margin-bottom:10px;">
        <%= formatted_collector_number(card.collector_number, card_set.code) %>
      </div>
      
      <!-- Quantity Input -->
      <div style="margin-bottom:6px;">
        <label style="display:block;color:#888;font-size:9px;margin-bottom:3px;">Regular</label>
        <input type="number" min="0" 
               data-binder-card-target="quantity"
               data-action="change->binder-card#save"
               value="<%= quantity %>"
               style="width:100%;background:#222;color:#fff;border:1px solid #444;padding:6px;border-radius:4px;text-align:center;font-size:14px;box-sizing:border-box;">
      </div>
      
      <!-- Foil Input -->
      <div>
        <label style="display:block;color:#a8f;font-size:9px;margin-bottom:3px;">Foil</label>
        <input type="number" min="0"
               data-binder-card-target="foilQuantity"
               data-action="change->binder-card#save"
               value="<%= foil_quantity %>"
               style="width:100%;background:linear-gradient(135deg, #2a2a3a 0%, #1a1a2a 100%);color:#fff;border:1px solid #555;padding:6px;border-radius:4px;text-align:center;font-size:14px;box-sizing:border-box;">
      </div>
    </div>
  </div>
</div>
