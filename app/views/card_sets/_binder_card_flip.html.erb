<%
  quantity = card.collection_card&.quantity.to_i
  foil_quantity = card.collection_card&.foil_quantity.to_i
  is_owned = quantity > 0 || foil_quantity > 0
%>
<div data-controller="binder-card" 
     data-card-id="<%= card.id %>"
     data-binder-card-card-set-id-value="<%= card_set.id %>"
     style="perspective:1000px;cursor:pointer;"
     title="Click to edit quantities">
  
  <!-- Card Container (flips) -->
  <div data-binder-card-target="card" 
       data-action="click->binder-card#flip"
       style="position:relative;aspect-ratio:5/7;transition:transform 0.5s;transform-style:preserve-3d;">
    
    <!-- Front (Card Image) -->
    <div data-binder-card-target="front"
         style="position:absolute;inset:0;backface-visibility:hidden;border-radius:4px;overflow:hidden;background:#222;<%= 'opacity:0.35;' unless is_owned %>">
      <% if card.image_path.present? %>
        <img src="/<%= card.image_path %>" alt="<%= card.name %>" 
             style="width:100%;height:100%;object-fit:cover;<%= 'filter:grayscale(100%);' unless is_owned %>" 
             onerror="this.src='/card_placeholder.webp'">
      <% else %>
        <img src="/card_placeholder.webp" alt="<%= card.name %>" 
             style="width:100%;height:100%;object-fit:cover;<%= 'filter:grayscale(100%);' unless is_owned %>">
      <% end %>
      
      <!-- Quantity Badges -->
      <% if is_owned %>
        <div class="quantity-badges" style="position:absolute;top:4px;right:4px;display:flex;gap:2px;">
          <% if quantity > 0 %>
            <div style="background:rgba(0,0,0,0.8);color:#4f8;padding:2px 6px;border-radius:3px;font-size:11px;font-weight:600;">
              x<%= quantity %>
            </div>
          <% end %>
          <% if foil_quantity > 0 %>
            <div style="background:linear-gradient(135deg, rgba(80,60,120,0.9) 0%, rgba(40,30,80,0.9) 100%);color:#c9f;padding:2px 6px;border-radius:3px;font-size:11px;font-weight:600;">
              x<%= foil_quantity %>
            </div>
          <% end %>
        </div>
      <% end %>
      
      <!-- Card number & position badge -->
      <div style="position:absolute;bottom:4px;left:4px;background:rgba(0,0,0,0.8);color:<%= is_owned ? '#fff' : '#666' %>;padding:2px 6px;border-radius:3px;font-size:9px;">
        <%= formatted_collector_number(card.collector_number, card_set.code) %>
      </div>
      <div style="position:absolute;bottom:4px;right:4px;background:rgba(0,0,0,0.6);color:#666;padding:2px 5px;border-radius:3px;font-size:9px;">
        #<%= position %>
      </div>
    </div>
    
    <!-- Back (Edit Form) -->
    <div data-binder-card-target="back"
         style="position:absolute;inset:0;backface-visibility:hidden;transform:rotateY(180deg);border-radius:4px;background:#2a2a2a;padding:12px;display:flex;flex-direction:column;justify-content:center;">
      
      <div style="color:#fff;font-size:11px;font-weight:500;margin-bottom:8px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
        <%= card.name %>
      </div>
      
      <div style="color:#666;font-size:9px;text-align:center;margin-bottom:12px;">
        <%= formatted_collector_number(card.collector_number, card_set.code) %>
      </div>
      
      <!-- Quantity Input -->
      <div style="margin-bottom:8px;">
        <label style="display:block;color:#888;font-size:10px;margin-bottom:4px;">Regular</label>
        <input type="number" min="0" 
               data-binder-card-target="quantity"
               data-action="change->binder-card#save"
               value="<%= quantity %>"
               style="width:100%;background:#222;color:#fff;border:1px solid #444;padding:8px;border-radius:4px;text-align:center;font-size:16px;box-sizing:border-box;">
      </div>
      
      <!-- Foil Input -->
      <div style="margin-bottom:12px;">
        <label style="display:block;color:#a8f;font-size:10px;margin-bottom:4px;">Foil</label>
        <input type="number" min="0"
               data-binder-card-target="foilQuantity"
               data-action="change->binder-card#save"
               value="<%= foil_quantity %>"
               style="width:100%;background:linear-gradient(135deg, #2a2a3a 0%, #1a1a2a 100%);color:#fff;border:1px solid #555;padding:8px;border-radius:4px;text-align:center;font-size:16px;box-sizing:border-box;">
      </div>
      
      <div style="color:#666;font-size:9px;text-align:center;">
        Click outside or tap card to close
      </div>
    </div>
  </div>
</div>
