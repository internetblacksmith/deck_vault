<div class="container mx-auto px-4 py-8">
  <div class="mb-6">
    <%= link_to "← Back to Sets", card_sets_path, class: "text-blue-500 hover:text-blue-700" %>
  </div>

  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex justify-between items-start">
      <div>
        <h1 class="text-4xl font-bold"><%= @card_set.name %></h1>
        <p class="text-gray-600 text-lg">Set Code: <%= @card_set.code %></p>
        <% if @card_set.released_at %>
          <p class="text-gray-600">Released: <%= @card_set.released_at.strftime("%B %d, %Y") %></p>
        <% end %>
      </div>
      <div class="text-right">
        <p class="text-2xl font-bold"><%= @cards.count %> / <%= @card_set.card_count %> Cards</p>
        <% owned = @cards.joins(:collection_card).count %>
        <% if owned > 0 %>
          <p class="text-green-600 text-lg">Owned: <%= owned %></p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- View Type Selector -->
  <div class="mb-4 flex gap-2">
    <%= link_to "Table View", card_set_path(@card_set, view_type: "table"), 
        class: "px-4 py-2 rounded #{@view_type == 'table' ? 'bg-blue-500 text-white' : 'bg-gray-200'}" %>
    <%= link_to "Grid View", card_set_path(@card_set, view_type: "grid"), 
        class: "px-4 py-2 rounded #{@view_type == 'grid' ? 'bg-blue-500 text-white' : 'bg-gray-200'}" %>
    <%= link_to "Binder Pages", card_set_path(@card_set, view_type: "binder"), 
        class: "px-4 py-2 rounded #{@view_type == 'binder' ? 'bg-blue-500 text-white' : 'bg-gray-200'}" %>
  </div>

  <!-- Table View -->
  <% if @view_type == "table" %>
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
      <table class="w-full">
        <thead class="bg-gray-100 border-b">
          <tr>
            <th class="px-4 py-3 text-left">Card Name</th>
            <th class="px-4 py-3 text-left">Type</th>
            <th class="px-4 py-3 text-left">Rarity</th>
            <th class="px-4 py-3 text-left">Quantity</th>
            <th class="px-4 py-3 text-left">Page #</th>
            <th class="px-4 py-3 text-left">Notes</th>
          </tr>
        </thead>
        <tbody>
          <% @cards.each do |card| %>
            <tr class="border-b hover:bg-gray-50" data-card-id="<%= card.id %>">
              <td class="px-4 py-3">
                <strong><%= card.name %></strong>
                <p class="text-sm text-gray-600"><%= card.collector_number %></p>
              </td>
              <td class="px-4 py-3 text-sm"><%= card.type_line %></td>
              <td class="px-4 py-3 text-sm">
                <span class="px-2 py-1 rounded text-xs font-semibold <%= rarity_class(card.rarity) %>">
                  <%= card.rarity&.upcase || "N/A" %>
                </span>
              </td>
              <td class="px-4 py-3">
                <input type="number" min="0" class="quantity-input w-16 px-2 py-1 border rounded" 
                       value="<%= card.collection_card&.quantity || 0 %>" 
                       data-card-id="<%= card.id %>">
              </td>
              <td class="px-4 py-3">
                <input type="number" min="1" max="200" class="page-input w-16 px-2 py-1 border rounded" 
                       value="<%= card.collection_card&.page_number || '' %>" 
                       placeholder="—"
                       data-card-id="<%= card.id %>">
              </td>
              <td class="px-4 py-3">
                <input type="text" class="notes-input w-full px-2 py-1 border rounded" 
                       value="<%= card.collection_card&.notes || '' %>" 
                       placeholder="Add notes..."
                       data-card-id="<%= card.id %>">
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% elsif @view_type == "grid" %>
    <div class="grid grid-cols-6 gap-4">
      <% @cards.each do |card| %>
        <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition" data-card-id="<%= card.id %>">
          <% if card.image_path %>
            <img src="/<%= card.image_path %>" alt="<%= card.name %>" class="w-full rounded mb-2" onerror="this.style.display='none'">
          <% elsif card.image_uris %>
            <% image_data = JSON.parse(card.image_uris) %>
            <% if image_data['normal'] %>
              <img src="<%= image_data['normal'] %>" alt="<%= card.name %>" class="w-full rounded mb-2">
            <% end %>
          <% end %>
          <h3 class="font-semibold text-sm mb-1 truncate"><%= card.name %></h3>
          <p class="text-xs text-gray-600 mb-3"><%= card.collector_number %></p>
          
          <div class="space-y-2 text-sm">
            <input type="number" min="0" class="quantity-input w-full px-2 py-1 border rounded text-center" 
                   value="<%= card.collection_card&.quantity || 0 %>" 
                   placeholder="Qty">
            <input type="number" min="1" max="200" class="page-input w-full px-2 py-1 border rounded text-center" 
                   value="<%= card.collection_card&.page_number || '' %>" 
                   placeholder="Page #">
          </div>
        </div>
      <% end %>
    </div>
  <% elsif @view_type == "binder" %>
    <div class="space-y-6">
      <% grouped_cards = @cards.includes(:collection_card).group_by { |c| c.collection_card&.page_number || 0 }.sort %>
      <% grouped_cards.each do |page, cards| %>
        <div class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-lg font-bold mb-4">
            <% if page == 0 %>
              Not Yet Placed
            <% else %>
              Page <%= page %>
            <% end %>
            <span class="text-gray-600 text-sm">(<%= cards.count %> cards)</span>
          </h3>
          <div class="grid grid-cols-4 gap-4">
            <% cards.each do |card| %>
              <div class="border rounded-lg p-3 text-center hover:bg-gray-50">
                <% if card.image_path %>
                  <img src="/<%= card.image_path %>" alt="<%= card.name %>" class="w-full rounded mb-2" onerror="this.style.display='none'">
                <% elsif card.image_uris %>
                  <% image_data = JSON.parse(card.image_uris) %>
                  <% if image_data['normal'] %>
                    <img src="<%= image_data['normal'] %>" alt="<%= card.name %>" class="w-full rounded mb-2">
                  <% end %>
                <% end %>
                <p class="font-semibold text-sm"><%= card.name %></p>
                <p class="text-xs text-gray-600"><%= card.collector_number %></p>
                <% if card.collection_card&.quantity && card.collection_card.quantity > 0 %>
                  <p class="text-xs text-green-600 font-semibold">Qty: <%= card.collection_card.quantity %></p>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Save card collection info when inputs change
    const saveCard = async (cardId, field, value) => {
      const row = document.querySelector(`[data-card-id="${cardId}"]`);
      const quantity = row.querySelector('.quantity-input').value || 0;
      const page_number = row.querySelector('.page-input').value || 0;
      const notes = row.querySelector('.notes-input')?.value || '';

      try {
        const response = await fetch(`<%= card_set_path(@card_set) %>/update_card`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
          },
          body: JSON.stringify({
            card_id: cardId,
            quantity: quantity,
            page_number: page_number,
            notes: notes
          })
        });

        if (response.ok) {
          row.classList.add('bg-green-50');
          setTimeout(() => row.classList.remove('bg-green-50'), 1500);
        }
      } catch (error) {
        console.error('Error saving card:', error);
      }
    };

    document.querySelectorAll('.quantity-input, .page-input, .notes-input').forEach(input => {
      input.addEventListener('change', (e) => {
        const cardId = e.target.dataset.cardId;
        saveCard(cardId, e.target.classList[0], e.target.value);
      });
    });
  });
</script>

<style>
  .container {
    max-width: 1400px;
  }

  .rarity-common {
    @apply bg-gray-300 text-gray-800;
  }

  .rarity-uncommon {
    @apply bg-blue-300 text-blue-900;
  }

  .rarity-rare {
    @apply bg-yellow-300 text-yellow-900;
  }

  .rarity-mythic {
    @apply bg-orange-300 text-orange-900;
  }
</style>
