<%= turbo_stream_from "card_set_#{@card_set.id}_progress" %>

<div>
  <!-- Header -->
  <div style="margin-bottom:24px;">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;">
      <div>
        <a href="<%= card_sets_path %>" style="color:#888;font-size:14px;text-decoration:none;">&larr; Back to Sets</a>
        <h1 style="font-size:28px;font-weight:600;color:#fff;margin-top:8px;"><%= @card_set.name %></h1>
        <div style="color:#666;margin-top:4px;">
          <%= @card_set.code.upcase %>
          <% if @card_set.released_at %>
            &middot; <%= @card_set.released_at.strftime("%B %Y") %>
          <% end %>
        </div>
      </div>
      
      <!-- Refresh Button -->
      <%= button_to refresh_cards_card_set_path(@card_set), 
          method: :post,
          style: "background:#333;color:#ccc;border:none;padding:8px 14px;border-radius:4px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:6px;",
          title: "Refresh cards from Scryfall (adds new cards without losing collection data)",
          data: { turbo_confirm: "Refresh cards from Scryfall? This will add any new cards and update existing card data. Your collection quantities will be preserved." } do %>
        <span style="font-size:16px;">&#8635;</span> Refresh
      <% end %>
    </div>
  </div>

  <!-- Stats -->
  <%
    # Force load cards with associations first to avoid strict_loading issues
    # This must happen before any other queries on @cards
    @cards_array ||= @cards.to_a

    # Main set stats (use preloaded data from controller - no extra queries!)
    main_set_cards = @main_set_cards
    main_total = main_set_cards.count
    main_owned = main_set_cards.count { |c| (c.collection_card&.quantity.to_i > 0) || (c.collection_card&.foil_quantity.to_i > 0) }
    main_completion = main_total > 0 ? (main_owned.to_f / main_total * 100).round(1) : 0

    # Normal cards stats (cards that can be nonfoil)
    normal_cards = main_set_cards.select { |c| c.nonfoil? }
    normal_total = normal_cards.count
    normal_owned = normal_cards.count { |c| c.collection_card&.quantity.to_i > 0 }
    normal_completion = normal_total > 0 ? (normal_owned.to_f / normal_total * 100).round(1) : 0

    # Foil cards stats (cards that can be foil)
    foil_cards = main_set_cards.select { |c| c.foil? }
    foil_total = foil_cards.count
    foil_owned = foil_cards.count { |c| c.collection_card&.foil_quantity.to_i > 0 }
    foil_completion = foil_total > 0 ? (foil_owned.to_f / foil_total * 100).round(1) : 0

    # Main set images stats
    main_images_downloaded = main_set_cards.count { |c| c.image_path.present? }
    main_images_completion = main_total > 0 ? (main_images_downloaded.to_f / main_total * 100).round(1) : 0

    # Related sets stats (child sets only) - use preloaded data from controller
    if @child_sets.any?
      # Use already eager-loaded cards from controller (no extra queries!)
      related_cards = @child_sets_with_cards.flat_map { |h| h[:cards] }

      related_total_cards = related_cards.count
      related_owned_cards = related_cards.count { |c| (c.collection_card&.quantity.to_i > 0) || (c.collection_card&.foil_quantity.to_i > 0) }
      related_completion = related_total_cards > 0 ? (related_owned_cards.to_f / related_total_cards * 100).round(1) : 0

      # Related Normal stats
      related_normal_cards = related_cards.select { |c| c.nonfoil? }
      related_normal_total = related_normal_cards.count
      related_normal_owned = related_normal_cards.count { |c| c.collection_card&.quantity.to_i > 0 }
      related_normal_completion = related_normal_total > 0 ? (related_normal_owned.to_f / related_normal_total * 100).round(1) : 0

      # Related Foil stats
      related_foil_cards = related_cards.select { |c| c.foil? }
      related_foil_total = related_foil_cards.count
      related_foil_owned = related_foil_cards.count { |c| c.collection_card&.foil_quantity.to_i > 0 }
      related_foil_completion = related_foil_total > 0 ? (related_foil_owned.to_f / related_foil_total * 100).round(1) : 0

      # Related Images stats
      related_images_downloaded = related_cards.count { |c| c.image_path.present? }
      related_images_completion = related_total_cards > 0 ? (related_images_downloaded.to_f / related_total_cards * 100).round(1) : 0

      # Combined stats (main + related)
      combined_total = main_total + related_total_cards
      combined_owned = main_owned + related_owned_cards
      combined_completion = combined_total > 0 ? (combined_owned.to_f / combined_total * 100).round(1) : 0

      # Combined Normal stats
      combined_normal_total = normal_total + related_normal_total
      combined_normal_owned = normal_owned + related_normal_owned
      combined_normal_completion = combined_normal_total > 0 ? (combined_normal_owned.to_f / combined_normal_total * 100).round(1) : 0

      # Combined Foil stats
      combined_foil_total = foil_total + related_foil_total
      combined_foil_owned = foil_owned + related_foil_owned
      combined_foil_completion = combined_foil_total > 0 ? (combined_foil_owned.to_f / combined_foil_total * 100).round(1) : 0

      # Combined Images stats
      combined_images_downloaded = main_images_downloaded + related_images_downloaded
      combined_images_completion = combined_total > 0 ? (combined_images_downloaded.to_f / combined_total * 100).round(1) : 0

      # Per-child set stats for the foldable section (use preloaded data)
      child_sets_stats = @child_sets_with_cards.map do |h|
        cs = h[:card_set]
        cs_cards = h[:cards]
        cs_total = cs_cards.count
        cs_owned = cs_cards.count { |c| (c.collection_card&.quantity.to_i > 0) || (c.collection_card&.foil_quantity.to_i > 0) }
        cs_completion = cs_total > 0 ? (cs_owned.to_f / cs_total * 100).round(1) : 0

        cs_normal = cs_cards.select { |c| c.nonfoil? }
        cs_normal_total = cs_normal.count
        cs_normal_owned = cs_normal.count { |c| c.collection_card&.quantity.to_i > 0 }
        cs_normal_completion = cs_normal_total > 0 ? (cs_normal_owned.to_f / cs_normal_total * 100).round(1) : 0

        cs_foil = cs_cards.select { |c| c.foil? }
        cs_foil_total = cs_foil.count
        cs_foil_owned = cs_foil.count { |c| c.collection_card&.foil_quantity.to_i > 0 }
        cs_foil_completion = cs_foil_total > 0 ? (cs_foil_owned.to_f / cs_foil_total * 100).round(1) : 0

        cs_images = cs_cards.count { |c| c.image_path.present? }
        cs_images_completion = cs_total > 0 ? (cs_images.to_f / cs_total * 100).round(1) : 0
        
        {
          set: cs,
          total: cs_total, owned: cs_owned, completion: cs_completion,
          normal_total: cs_normal_total, normal_owned: cs_normal_owned, normal_completion: cs_normal_completion,
          foil_total: cs_foil_total, foil_owned: cs_foil_owned, foil_completion: cs_foil_completion,
          images_downloaded: cs_images, images_completion: cs_images_completion
        }
      end
    end
    
    # Page stats (what's shown in the current view - respects include_subsets)
    page_total = @cards_array.count
    page_owned = @cards_array.count { |c| (c.collection_card&.quantity.to_i > 0) || (c.collection_card&.foil_quantity.to_i > 0) }
    page_completion = page_total > 0 ? (page_owned.to_f / page_total * 100).round(1) : 0
  %>
  
  <% if @child_sets.any? %>
    <!-- Stats Table with Main/Related/Combined rows and Total/Normal/Foil/Images columns -->
    <div data-controller="collapsible" style="margin:24px 0;">
      <table style="width:100%;border-collapse:separate;border-spacing:2px;background:#333;border-radius:6px;">
        <!-- Header Row -->
        <thead>
          <tr>
            <th style="background:#252525;padding:12px 16px;text-align:left;border-radius:6px 0 0 0;"></th>
            <th style="background:#252525;padding:12px 16px;text-align:center;">
              <div style="color:#888;font-size:12px;text-transform:uppercase;letter-spacing:0.5px;">Total</div>
            </th>
            <th style="background:#252525;padding:12px 16px;text-align:center;">
              <div style="color:#888;font-size:12px;text-transform:uppercase;letter-spacing:0.5px;">Normal</div>
            </th>
            <th style="background:linear-gradient(135deg, #2a2a3a 0%, #252525 100%);padding:12px 16px;text-align:center;">
              <div style="color:#a8f;font-size:12px;text-transform:uppercase;letter-spacing:0.5px;">Foil</div>
            </th>
            <th style="background:#252525;padding:12px 16px;text-align:center;border-radius:0 6px 0 0;">
              <div style="color:#888;font-size:12px;text-transform:uppercase;letter-spacing:0.5px;">Images</div>
            </th>
          </tr>
        </thead>
        <tbody>
          <!-- Main Set Row -->
          <tr>
            <td style="background:#1a1a1a;padding:12px 16px;">
              <div style="color:#fff;font-size:13px;font-weight:500;">Main Set</div>
            </td>
            <td style="background:#1a1a1a;padding:12px 16px;text-align:center;">
              <div style="font-size:18px;font-weight:600;color:#fff;"><%= main_owned %>/<%= main_total %></div>
              <div style="color:<%= percentage_color(main_completion) %>;font-size:12px;"><%= main_completion %>%</div>
            </td>
            <td style="background:#1a1a1a;padding:12px 16px;text-align:center;">
              <div style="font-size:18px;font-weight:600;color:#fff;"><%= normal_owned %>/<%= normal_total %></div>
              <div style="color:<%= percentage_color(normal_completion) %>;font-size:12px;"><%= normal_completion %>%</div>
            </td>
            <td style="background:linear-gradient(135deg, #1a1a2a 0%, #1a1a1a 100%);padding:12px 16px;text-align:center;">
              <div style="font-size:18px;font-weight:600;color:#fff;"><%= foil_owned %>/<%= foil_total %></div>
              <div style="color:<%= percentage_color(foil_completion) %>;font-size:12px;"><%= foil_completion %>%</div>
            </td>
            <%= turbo_frame_tag "progress-#{@card_set.id}" do %>
              <%= render "card_sets/images_stats_card", card_set: @card_set, total_cards: main_total, compact: true, as_td: true %>
            <% end %>
          </tr>
          
          <!-- Related Sets Row (Clickable to expand) -->
          <tr>
            <td style="background:#1a1a1a;padding:0;">
              <button data-action="click->collapsible#toggle" 
                      style="background:#1a1a1a;padding:12px 16px;border:none;cursor:pointer;text-align:left;display:flex;align-items:center;gap:8px;width:100%;">
                <span data-collapsible-target="icon" style="color:#888;font-size:12px;width:12px;">+</span>
                <div style="color:#fff;font-size:13px;font-weight:500;">Related <span style="color:#666;font-weight:400;">(<%= @child_sets.count %>)</span></div>
              </button>
            </td>
            <td style="background:#1a1a1a;padding:12px 16px;text-align:center;">
              <div style="font-size:18px;font-weight:600;color:#fff;"><%= related_owned_cards %>/<%= related_total_cards %></div>
              <div style="color:<%= percentage_color(related_completion) %>;font-size:12px;"><%= related_completion %>%</div>
            </td>
            <td style="background:#1a1a1a;padding:12px 16px;text-align:center;">
              <div style="font-size:18px;font-weight:600;color:#fff;"><%= related_normal_owned %>/<%= related_normal_total %></div>
              <div style="color:<%= percentage_color(related_normal_completion) %>;font-size:12px;"><%= related_normal_completion %>%</div>
            </td>
            <td style="background:linear-gradient(135deg, #1a1a2a 0%, #1a1a1a 100%);padding:12px 16px;text-align:center;">
              <div style="font-size:18px;font-weight:600;color:#fff;"><%= related_foil_owned %>/<%= related_foil_total %></div>
              <div style="color:<%= percentage_color(related_foil_completion) %>;font-size:12px;"><%= related_foil_completion %>%</div>
            </td>
            <td style="background:#1a1a1a;padding:12px 16px;text-align:center;">
              <div style="font-size:18px;font-weight:600;color:#fff;"><%= related_images_downloaded %>/<%= related_total_cards %></div>
              <div style="color:<%= percentage_color(related_images_completion) %>;font-size:12px;"><%= related_images_completion %>%</div>
            </td>
          </tr>
          
          <!-- Child Sets Rows (Hidden by default) -->
          <% child_sets_stats.each do |cs_stats| %>
            <tr data-collapsible-target="content" style="display:none;">
              <td style="background:#151515;padding:10px 16px 10px 32px;">
                <a href="<%= card_set_path(cs_stats[:set]) %>" style="text-decoration:none;display:flex;align-items:center;gap:8px;">
                  <div style="color:#ccc;font-size:12px;font-weight:400;"><%= cs_stats[:set].name %></div>
                  <div style="color:#666;font-size:11px;">(<%= cs_stats[:set].code.upcase %>)</div>
                </a>
              </td>
              <td style="background:#151515;padding:10px 16px;text-align:center;">
                <div style="font-size:16px;font-weight:600;color:#fff;"><%= cs_stats[:owned] %>/<%= cs_stats[:total] %></div>
                <div style="color:<%= percentage_color(cs_stats[:completion]) %>;font-size:11px;"><%= cs_stats[:completion] %>%</div>
              </td>
              <td style="background:#151515;padding:10px 16px;text-align:center;">
                <div style="font-size:16px;font-weight:600;color:#fff;"><%= cs_stats[:normal_owned] %>/<%= cs_stats[:normal_total] %></div>
                <div style="color:<%= percentage_color(cs_stats[:normal_completion]) %>;font-size:11px;"><%= cs_stats[:normal_completion] %>%</div>
              </td>
              <td style="background:linear-gradient(135deg, #15151f 0%, #151515 100%);padding:10px 16px;text-align:center;">
                <div style="font-size:16px;font-weight:600;color:#fff;"><%= cs_stats[:foil_owned] %>/<%= cs_stats[:foil_total] %></div>
                <div style="color:<%= percentage_color(cs_stats[:foil_completion]) %>;font-size:11px;"><%= cs_stats[:foil_completion] %>%</div>
              </td>
              <td style="background:#151515;padding:10px 16px;text-align:center;">
                <div style="font-size:16px;font-weight:600;color:#fff;"><%= cs_stats[:images_downloaded] %>/<%= cs_stats[:total] %></div>
                <div style="color:<%= percentage_color(cs_stats[:images_completion]) %>;font-size:11px;"><%= cs_stats[:images_completion] %>%</div>
              </td>
            </tr>
          <% end %>
          
          <!-- Combined Row -->
          <tr>
            <td style="background:<%= @include_subsets ? '#1a2a1a' : '#1a1a1a' %>;padding:12px 16px;<%= @include_subsets ? 'border-left:2px solid #4a4;' : '' %>border-radius:0 0 0 6px;">
              <div style="color:#fff;font-size:13px;font-weight:500;">Combined<%= ' *' if @include_subsets %></div>
            </td>
            <td style="background:<%= @include_subsets ? '#1a2a1a' : '#1a1a1a' %>;padding:12px 16px;text-align:center;">
              <div style="font-size:18px;font-weight:600;color:#fff;"><%= combined_owned %>/<%= combined_total %></div>
              <div style="color:<%= percentage_color(combined_completion) %>;font-size:12px;"><%= combined_completion %>%</div>
            </td>
            <td style="background:<%= @include_subsets ? '#1a2a1a' : '#1a1a1a' %>;padding:12px 16px;text-align:center;">
              <div style="font-size:18px;font-weight:600;color:#fff;"><%= combined_normal_owned %>/<%= combined_normal_total %></div>
              <div style="color:<%= percentage_color(combined_normal_completion) %>;font-size:12px;"><%= combined_normal_completion %>%</div>
            </td>
            <td style="background:linear-gradient(135deg, <%= @include_subsets ? '#1a2a2a' : '#1a1a2a' %> 0%, <%= @include_subsets ? '#1a2a1a' : '#1a1a1a' %> 100%);padding:12px 16px;text-align:center;">
              <div style="font-size:18px;font-weight:600;color:#fff;"><%= combined_foil_owned %>/<%= combined_foil_total %></div>
              <div style="color:<%= percentage_color(combined_foil_completion) %>;font-size:12px;"><%= combined_foil_completion %>%</div>
            </td>
            <td style="background:<%= @include_subsets ? '#1a2a1a' : '#1a1a1a' %>;padding:12px 16px;text-align:center;border-radius:0 0 6px 0;">
              <div style="font-size:18px;font-weight:600;color:#fff;"><%= combined_images_downloaded %>/<%= combined_total %></div>
              <div style="color:<%= percentage_color(combined_images_completion) %>;font-size:12px;"><%= combined_images_completion %>%</div>
            </td>
          </tr>
        </tbody>
      </table>
      <% if @include_subsets %>
        <div style="color:#666;font-size:12px;margin-top:8px;">* Currently showing combined view</div>
      <% end %>
    </div>
  <% else %>
    <!-- Simple stats (no child sets) -->
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin:24px 0;">
      <div style="background:#1a1a1a;padding:16px;border-radius:6px;">
        <div style="color:#888;font-size:13px;">Cards</div>
        <div style="font-size:24px;font-weight:600;color:#fff;"><%= main_owned %>/<%= main_total %></div>
        <div style="color:<%= percentage_color(main_completion) %>;font-size:13px;margin-top:4px;"><%= main_completion %>%</div>
      </div>
      <div style="background:#1a1a1a;padding:16px;border-radius:6px;">
        <div style="color:#888;font-size:13px;">Normal</div>
        <div style="font-size:24px;font-weight:600;color:#fff;"><%= normal_owned %>/<%= normal_total %></div>
        <div style="color:<%= percentage_color(normal_completion) %>;font-size:13px;margin-top:4px;"><%= normal_completion %>%</div>
      </div>
      <div style="background:linear-gradient(135deg, #1a1a2a 0%, #1a1a1a 100%);padding:16px;border-radius:6px;">
        <div style="color:#a8f;font-size:13px;">Foil</div>
        <div style="font-size:24px;font-weight:600;color:#fff;"><%= foil_owned %>/<%= foil_total %></div>
        <div style="color:<%= percentage_color(foil_completion) %>;font-size:13px;margin-top:4px;"><%= foil_completion %>%</div>
      </div>
      <div style="background:#1a1a1a;padding:16px;border-radius:6px;">
        <div style="color:#888;font-size:13px;">Unique</div>
        <div style="font-size:24px;font-weight:600;color:#fff;"><%= main_owned %></div>
        <div style="color:#666;font-size:13px;margin-top:4px;">cards owned</div>
      </div>
      <%= turbo_frame_tag "progress-#{@card_set.id}" do %>
        <%= render "card_sets/images_stats_card", card_set: @card_set, total_cards: main_total %>
      <% end %>
    </div>
  <% end %>



  <% if @view_type != "binder" %>
  <div data-controller="card-sort" data-card-sort-view-value="<%= @view_type %>">
  <% end %>
  
  <!-- View Toggle and Sort Controls -->
  <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:24px;">
    <div style="display:flex;gap:8px;align-items:center;">
      <% view_tooltips = {
           "table" => "List view with card details, quantities, and page numbers",
           "grid" => "Visual grid showing card images with hover-to-edit",
           "binder" => "Physical binder simulation with page navigation"
         } %>
      <% ["table", "grid", "binder"].each do |view| %>
        <a href="<%= card_set_path(@card_set, view_type: view, include_subsets: (@view_type != "binder" && @include_subsets) || nil) %>"
           style="padding:8px 16px;border-radius:4px;text-decoration:none;font-size:14px;<%= @view_type == view ? 'background:#29f;color:#fff;' : 'background:#333;color:#ccc;' %>"
           title="<%= view_tooltips[view] %>">
          <%= view.capitalize %>
        </a>
      <% end %>
      
      <!-- Import CSV Button -->
      <div style="margin-left:16px;" data-controller="csv-import">
        <button data-action="click->csv-import#toggle"
                title="Import card quantities from a CSV file (tab or comma separated)"
                style="background:#333;color:#ccc;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:14px;">
          Import CSV
        </button>
        <div data-csv-import-target="panel" style="display:none;position:absolute;background:#1a1a1a;border:1px solid #444;border-radius:6px;padding:16px;margin-top:8px;z-index:100;min-width:300px;">
          <%= form_tag import_csv_card_set_path(@card_set), method: :post, multipart: true do %>
            <div style="margin-bottom:12px;">
              <label style="display:block;color:#888;font-size:12px;margin-bottom:6px;">Select CSV file from scanner app</label>
              <%= file_field_tag :csv_file, accept: ".csv,.txt", style: "width:100%;background:#222;color:#eee;border:1px solid #444;padding:8px;border-radius:4px;font-size:13px;" %>
            </div>
            <div style="display:flex;gap:8px;">
              <%= submit_tag "Import", style: "flex:1;background:#29f;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:14px;" %>
              <button type="button" data-action="click->csv-import#toggle" 
                      style="background:#333;color:#ccc;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:14px;">
                Cancel
              </button>
            </div>
            <p style="color:#666;font-size:11px;margin:12px 0 0 0;">
              Supports tab or comma-separated CSV files. Cards are matched by collector number or name.
            </p>
          <% end %>
        </div>
      </div>
    </div>
    
    <div style="display:flex;gap:12px;align-items:center;">
      <% if @view_type == "binder" %>
        <!-- Binder: Search only (other controls in settings panel) -->
        <input type="text" 
               id="binder-search"
               placeholder="Search cards..."
               oninput="window.binderSearch(this.value)"
               style="background:#222;color:#eee;border:1px solid #444;padding:8px 12px;border-radius:4px;width:180px;">
        <script>
          window.binderSearch = function(query) {
            query = query.toLowerCase().trim();
            document.querySelectorAll("[data-controller='binder-card']").forEach(function(card) {
              var name = card.dataset.cardName || "";
              var number = card.dataset.cardNumber || "";
              var type = card.dataset.cardType || "";
              var matches = query === "" || name.includes(query) || number.includes(query) || type.includes(query);
              card.style.display = matches ? "" : "none";
            });
          };
        </script>
      <% else %>
        <!-- Table/Grid: Search (supports wildcards: * for any chars, ? for single char) -->
        <input type="text" 
               data-card-sort-target="searchField" 
               data-action="input->card-sort#search"
               placeholder="Search (? * wildcards)..."
               title="Wildcards: ? = one char, * = any chars. Examples: 22? matches 220-229, 22* matches 22+, *dragon matches ends with dragon"
               style="background:#222;color:#eee;border:1px solid #444;padding:8px 12px;border-radius:4px;width:180px;">
        
        <!-- Filter -->
        <div style="display:flex;gap:8px;align-items:center;">
          <span style="color:#888;font-size:13px;">Show:</span>
          <select data-card-sort-target="filterField" data-action="change->card-sort#filter" style="background:#222;color:#eee;border:1px solid #444;padding:8px 12px;border-radius:4px;cursor:pointer;">
            <option value="all">All Cards</option>
            <option value="owned">Owned</option>
            <option value="missing">Missing</option>
            <option value="foil-only">Foil Only</option>
            <option value="nonfoil-only">Nonfoil Only</option>
          </select>
        </div>
        
        <!-- Sort -->
        <div style="display:flex;gap:8px;align-items:center;">
          <span style="color:#888;font-size:13px;">Sort by:</span>
          <select data-card-sort-target="sortField" data-action="change->card-sort#sort" style="background:#222;color:#eee;border:1px solid #444;padding:8px 12px;border-radius:4px;cursor:pointer;">
            <option value="number">Set/Number</option>
            <option value="name">Name</option>
            <option value="rarity">Rarity</option>
            <option value="color">Color</option>
            <option value="mana">Mana Value</option>
            <option value="type">Type</option>
          </select>
          <select data-card-sort-target="sortDirection" data-action="change->card-sort#sort" style="background:#222;color:#eee;border:1px solid #444;padding:8px 12px;border-radius:4px;cursor:pointer;">
            <option value="asc">Asc</option>
            <option value="desc">Desc</option>
          </select>
        </div>
        
        <% if @child_sets.any? %>
          <!-- Include Related Sets Toggle -->
          <a href="<%= card_set_path(@card_set, view_type: @view_type, include_subsets: !@include_subsets || nil, group_by_set: @group_by_set || nil) %>"
             title="Include cards from related sets like tokens, promos, and commander decks"
             style="display:flex;align-items:center;gap:6px;padding:8px 12px;border-radius:4px;text-decoration:none;font-size:13px;border-left:1px solid #444;padding-left:16px;margin-left:4px;<%= @include_subsets ? 'background:#4a3;color:#fff;' : 'background:#333;color:#888;' %>">
            <span style="font-size:14px;"><%= @include_subsets ? '&#9745;' : '&#9744;' %></span>
            Include Related
          </a>
        <% end %>
        
        <% if %w[grid table].include?(@view_type) && @include_subsets %>
          <!-- Group by Set Toggle (grid and table views with subsets) -->
          <a href="<%= card_set_path(@card_set, view_type: @view_type, include_subsets: @include_subsets || nil, group_by_set: !@group_by_set || nil) %>"
             title="Group cards by their set with section headers"
             style="display:flex;align-items:center;gap:6px;padding:8px 12px;border-radius:4px;text-decoration:none;font-size:13px;<%= @group_by_set ? 'background:#369;color:#fff;' : 'background:#333;color:#888;' %>">
            <span style="font-size:14px;"><%= @group_by_set ? '&#9745;' : '&#9744;' %></span>
            Group by Set
          </a>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Content -->
  <% if @view_type == "table" %>
    <%
      # Calculate binder settings for page column
      binder_rows = @card_set.binder_rows || 3
      binder_columns = @card_set.binder_columns || 3
      cards_per_page = binder_rows * binder_columns
    %>
    <% if @cards_by_set %>
      <!-- Grouped by Set -->
      <% card_position = 0 %>
      <% @cards_by_set.each do |set, set_cards| %>
        <div data-card-sort-target="setGroup" style="margin-bottom:24px;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
            <h3 style="font-size:16px;font-weight:500;color:#fff;margin:0;"><%= set.name %></h3>
            <span style="color:#666;font-size:13px;"><%= set.code.upcase %></span>
            <span style="color:#888;font-size:13px;"><%= set_cards.count %> cards</span>
          </div>
          <div style="background:#1a1a1a;border-radius:6px;overflow:hidden;">
            <table style="width:100%;">
              <thead>
                <tr style="border-bottom:1px solid #333;">
                  <th style="padding:12px 16px;color:#888;font-weight:500;text-align:left;">Name</th>
                  <th style="padding:12px 16px;color:#888;font-weight:500;text-align:left;">Type</th>
                  <th style="padding:12px 16px;color:#888;font-weight:500;text-align:left;">Rarity</th>
                  <th style="padding:12px 16px;color:#888;font-weight:500;text-align:center;">Page</th>
                  <th style="padding:12px 16px;color:#888;font-weight:500;text-align:center;">Qty</th>
                  <th style="padding:12px 16px;color:#888;font-weight:500;text-align:center;">Foil</th>
                  <th style="padding:12px 16px;color:#888;font-weight:500;text-align:left;">Notes</th>
                </tr>
              </thead>
              <tbody data-card-sort-target="container">
                <% set_cards.each_with_index do |card, index| %>
                  <% card_position += 1 %>
                  <%= turbo_frame_tag "card-row-#{card.id}" do %>
                    <%= render "card_sets/card_row", card: card, view_type: @view_type, card_set: set, position: card_position, cards_per_page: cards_per_page %>
                  <% end %>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      <% end %>
    <% else %>
      <!-- Single Set -->
      <div style="background:#1a1a1a;border-radius:6px;overflow:hidden;">
        <table style="width:100%;">
          <thead>
            <tr style="border-bottom:1px solid #333;">
              <th style="padding:12px 16px;color:#888;font-weight:500;text-align:left;">Name</th>
              <th style="padding:12px 16px;color:#888;font-weight:500;text-align:left;">Type</th>
              <th style="padding:12px 16px;color:#888;font-weight:500;text-align:left;">Rarity</th>
              <th style="padding:12px 16px;color:#888;font-weight:500;text-align:center;">Page</th>
              <th style="padding:12px 16px;color:#888;font-weight:500;text-align:center;">Qty</th>
              <th style="padding:12px 16px;color:#888;font-weight:500;text-align:center;">Foil</th>
              <th style="padding:12px 16px;color:#888;font-weight:500;text-align:left;">Notes</th>
            </tr>
          </thead>
          <tbody data-card-sort-target="container">
            <% @cards.each_with_index do |card, index| %>
              <%= turbo_frame_tag "card-row-#{card.id}" do %>
                <%= render "card_sets/card_row", card: card, view_type: @view_type, card_set: @card_set, position: index + 1, cards_per_page: cards_per_page %>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  </div>

  <% elsif @view_type == "grid" %>
    <% if @cards_by_set %>
      <!-- Grouped by Set -->
      <% @cards_by_set.each do |set, set_cards| %>
        <div data-card-sort-target="setGroup" style="margin-bottom:24px;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
            <h3 style="font-size:16px;font-weight:500;color:#fff;margin:0;"><%= set.name %></h3>
            <span style="color:#666;font-size:13px;"><%= set.code.upcase %></span>
            <span style="color:#888;font-size:13px;"><%= set_cards.count %> cards</span>
          </div>
          <div data-card-sort-target="container" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;">
            <% set_cards.each do |card| %>
              <%= render "card_sets/grid_card", card: card, card_set: set %>
            <% end %>
          </div>
        </div>
      <% end %>
    <% else %>
      <div data-card-sort-target="container" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;">
        <% @cards.each do |card| %>
          <%= render "card_sets/grid_card", card: card %>
        <% end %>
      </div>
    <% end %>
  </div>

  <% elsif @view_type == "binder" %>
    <%
      # Get binder settings with defaults
      binder_rows = @card_set.binder_rows || 3
      binder_columns = @card_set.binder_columns || 3
      cards_per_page = binder_rows * binder_columns
      sort_field = @card_set.binder_sort_field || "number"
      sort_direction = @card_set.binder_sort_direction || "asc"
      pages_per_binder = @card_set.binder_pages_per_binder # nil means unlimited
      
      # Sort cards based on binder settings
      # Use pre-loaded cards array to ensure collection_card associations are available
      # When including subsets, sort by set first to keep sets grouped together
      sorted_cards = @cards_array.sort_by do |card|
        base_sort = case sort_field
          when "number" then sortable_collector_number(card.collector_number)
          when "name" then card.name.downcase
          when "rarity" then rarity_sort_value(card.rarity)
          when "color" then color_sort_value(card.mana_cost)
          when "mana" then mana_value(card.mana_cost)
          when "type" then card.type_line&.downcase || ""
          else sortable_collector_number(card.collector_number)
        end
        # When including subsets, group by set first
        if @include_subsets
          [card.card_set_id == @card_set.id ? 0 : 1, card.card_set_id, base_sort]
        else
          base_sort
        end
      end
      sorted_cards = sorted_cards.reverse if sort_direction == "desc"
      
      # Group cards into pages
      binder_pages = sorted_cards.each_slice(cards_per_page).to_a
      
      # Build spreads with binder breaks
      # A spread is [left_page, right_page] where each page is either:
      # - An array of cards
      # - :empty (placeholder for empty page at binder boundary)
      # - :cover (the cover/stats page)
      #
      # Page numbering (1-indexed):
      # - Page 1 is on cover spread (right side)
      # - Pages 2-3 are on spread 1, Pages 4-5 on spread 2, etc.
      #
      # If pages_per_binder is set (e.g., 56):
      # - Page 56 is the last page of binder 1, so spread with page 56 has empty right
      # - Next spread has empty left and page 57 on right (first page of binder 2)
      # - Then normal spreads continue: 58-59, 60-61, etc.
      
      all_spreads = []
      
      if pages_per_binder.present? && pages_per_binder > 0
        # Build pages with binder breaks inserted
        # Track which binder each page belongs to and insert breaks
        page_number = 1
        page_index = 0
        pages_with_breaks = []
        
        while page_index < binder_pages.count
          current_binder = ((page_number - 1) / pages_per_binder) + 1
          position_in_binder = ((page_number - 1) % pages_per_binder) + 1
          
          # Add the actual page
          pages_with_breaks << { type: :cards, cards: binder_pages[page_index], page_num: page_number, binder: current_binder }
          page_index += 1
          
          # If this is the last page of a binder and there are more pages coming
          if position_in_binder == pages_per_binder && page_index < binder_pages.count
            # Check if this page would be on the left side of a spread (even page number)
            # Page 1 is on right of cover, Page 2 is on left, Page 3 on right, etc.
            # So even pages are on the left, odd on the right
            if page_number.even?
              # This page is on the left, add empty on right for back cover
              pages_with_breaks << { type: :binder_end, binder: current_binder }
              # Then add empty on left for next binder's front cover, next card page on right
              pages_with_breaks << { type: :binder_start, binder: current_binder + 1 }
            else
              # This page is on the right, need empty left+right for binder transition
              # The current spread already has this page on right
              # Next spread: empty left (back cover), empty right (would need another spread)
              # Actually: back cover on left of next spread, front cover on right
              # Then: next spread has empty left (inside front cover) and first page of new binder
              pages_with_breaks << { type: :binder_end, binder: current_binder }
              pages_with_breaks << { type: :binder_start, binder: current_binder + 1 }
            end
          end
          
          page_number += 1
        end
        
        # Now pair up pages into spreads
        # Cover spread: stats (left) + page 1 (right)
        # Then pair remaining pages
        
        # First page goes with cover
        first_page = pages_with_breaks.shift if pages_with_breaks.any?
        remaining_pages = pages_with_breaks
        
        # Pair remaining pages into spreads
        spread_pages = remaining_pages.each_slice(2).to_a
      else
        # No binder breaks - simple pairing
        first_page = binder_pages.any? ? { type: :cards, cards: binder_pages[0], page_num: 1, binder: 1 } : nil
        remaining_pages = binder_pages[1..].to_a.map.with_index do |cards, idx|
          { type: :cards, cards: cards, page_num: idx + 2, binder: 1 }
        end
        spread_pages = remaining_pages.each_slice(2).to_a
      end
      
      total_spreads = spread_pages.count + 1 # +1 for cover spread
    %>
    
    <%
      # Count cards needing placement in this view
      needs_placement_count = sorted_cards.count { |c| c.collection_card&.needs_placement? }
    %>
    <!-- Binder Configuration -->
    <div data-controller="binder-settings"
         data-binder-settings-url-value="<%= update_binder_settings_card_set_path(@card_set) %>"
         style="margin-bottom:24px;">

      <!-- Info Bar with Settings -->
      <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;">
        <div style="display:flex;align-items:center;gap:16px;">
          <div style="color:#888;font-size:13px;">
            <%= binder_rows %>&times;<%= binder_columns %> layout &middot; <%= cards_per_page %> cards/page &middot; <%= binder_pages.count %> pages
          </div>
          <% if needs_placement_count > 0 %>
            <%= button_to clear_placement_markers_card_set_path(@card_set),
                method: :post,
                data: {
                  placement_count: needs_placement_count,
                  turbo_confirm: "Clear all #{needs_placement_count} placement markers? This marks all NEW cards as placed in your binder."
                },
                style: "background:#d4a017;color:#1a1a1a;border:1px solid #b8860b;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px;" do %>
              Clear All (<span data-count><%= needs_placement_count %></span>)
            <% end %>
          <% end %>
        </div>
        
        <!-- Settings Cog Button -->
        <button data-action="click->binder-settings#toggle" 
                title="Binder Settings"
                style="background:#333;color:#ccc;border:none;width:36px;height:36px;border-radius:4px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;">
          &#9881;
        </button>
      </div>
      
      <!-- Settings Panel (hidden by default) -->
      <div data-binder-settings-target="panel" 
           style="display:none;background:#1a1a1a;border-radius:6px;padding:16px;margin-top:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h4 style="color:#fff;font-size:14px;font-weight:500;margin:0;">Binder Settings</h4>
          <button data-action="click->binder-settings#toggle" 
                  style="background:transparent;border:none;color:#666;cursor:pointer;font-size:18px;line-height:1;">
            &times;
          </button>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:16px;align-items:center;">
          <div style="display:flex;gap:8px;align-items:center;">
            <span style="color:#888;font-size:13px;">Rows:</span>
            <select data-binder-settings-target="rows" data-action="change->binder-settings#save" style="background:#222;color:#eee;border:1px solid #444;padding:6px 10px;border-radius:4px;cursor:pointer;">
              <% (1..6).each do |n| %>
                <option value="<%= n %>" <%= n == binder_rows ? 'selected' : '' %>><%= n %></option>
              <% end %>
            </select>
          </div>
          
          <div style="display:flex;gap:8px;align-items:center;">
            <span style="color:#888;font-size:13px;">Columns:</span>
            <select data-binder-settings-target="columns" data-action="change->binder-settings#save" style="background:#222;color:#eee;border:1px solid #444;padding:6px 10px;border-radius:4px;cursor:pointer;">
              <% (1..6).each do |n| %>
                <option value="<%= n %>" <%= n == binder_columns ? 'selected' : '' %>><%= n %></option>
              <% end %>
            </select>
          </div>
          
          <div style="display:flex;gap:8px;align-items:center;">
            <span style="color:#888;font-size:13px;">Sort by:</span>
            <select data-binder-settings-target="sortField" data-action="change->binder-settings#save" style="background:#222;color:#eee;border:1px solid #444;padding:6px 10px;border-radius:4px;cursor:pointer;">
              <option value="number" <%= sort_field == "number" ? 'selected' : '' %>>Set/Number</option>
              <option value="name" <%= sort_field == "name" ? 'selected' : '' %>>Name</option>
              <option value="rarity" <%= sort_field == "rarity" ? 'selected' : '' %>>Rarity</option>
              <option value="color" <%= sort_field == "color" ? 'selected' : '' %>>Color</option>
              <option value="mana" <%= sort_field == "mana" ? 'selected' : '' %>>Mana Value</option>
              <option value="type" <%= sort_field == "type" ? 'selected' : '' %>>Type</option>
            </select>
            <select data-binder-settings-target="sortDirection" data-action="change->binder-settings#save" style="background:#222;color:#eee;border:1px solid #444;padding:6px 10px;border-radius:4px;cursor:pointer;">
              <option value="asc" <%= sort_direction == "asc" ? 'selected' : '' %>>Asc</option>
              <option value="desc" <%= sort_direction == "desc" ? 'selected' : '' %>>Desc</option>
            </select>
          </div>
          
          <div style="display:flex;gap:8px;align-items:center;border-left:1px solid #444;padding-left:16px;">
            <span style="color:#888;font-size:13px;">Pages/Binder:</span>
            <input type="number" 
                   data-binder-settings-target="pagesPerBinder" 
                   data-action="change->binder-settings#save"
                   value="<%= pages_per_binder %>"
                   placeholder="Unlimited"
                   min="1"
                   max="500"
                   style="background:#222;color:#eee;border:1px solid #444;padding:6px 10px;border-radius:4px;width:90px;text-align:center;">
          </div>
          
          <% if @child_sets.any? %>
            <div style="display:flex;gap:8px;align-items:center;border-left:1px solid #444;padding-left:16px;">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;color:#888;font-size:13px;">
                <input type="checkbox" 
                       data-binder-settings-target="includeSubsets" 
                       data-action="change->binder-settings#save"
                       <%= @include_subsets ? 'checked' : '' %>
                       style="width:16px;height:16px;cursor:pointer;">
                Include Related Sets
              </label>
            </div>
          <% end %>
        </div>
        <p style="color:#666;font-size:12px;margin:12px 0 0 0;">
          Changes are saved automatically and will reload the page.
        </p>
      </div>
    </div>
    
    <%
      # Calculate collection stats for cover page
      total_cards_in_set = sorted_cards.count
      owned_regular = sorted_cards.count { |c| c.collection_card&.quantity.to_i > 0 }
      owned_foil = sorted_cards.count { |c| c.collection_card&.foil_quantity.to_i > 0 }
      owned_any = sorted_cards.count { |c| (c.collection_card&.quantity.to_i > 0) || (c.collection_card&.foil_quantity.to_i > 0) }
      total_regular = sorted_cards.sum { |c| c.collection_card&.quantity.to_i }
      total_foil = sorted_cards.sum { |c| c.collection_card&.foil_quantity.to_i }
      completion_pct = total_cards_in_set > 0 ? (owned_any.to_f / total_cards_in_set * 100).round(1) : 0
      total_binder_pages = binder_pages.count
      total_binders = pages_per_binder.present? && pages_per_binder > 0 ? ((total_binder_pages - 1) / pages_per_binder) + 1 : 1
      
      # Total spreads with cover already calculated above
      total_spreads_with_cover = total_spreads
    %>
    
    <!-- Binder View -->
    <div data-controller="binder" 
         data-binder-total-spreads-value="<%= total_spreads_with_cover %>"
         data-binder-cards-per-page-value="<%= cards_per_page %>"
         data-action="keydown->binder#keydown"
         tabindex="0"
         style="outline:none;">
      
      <!-- Navigation -->
      <div style="display:flex;justify-content:center;align-items:center;gap:16px;margin-bottom:20px;">
        <button data-binder-target="prevBtn" data-action="click->binder#previousSpread"
                style="background:#333;color:#fff;border:none;padding:10px 20px;border-radius:4px;cursor:pointer;font-size:14px;">
          &larr; Previous
        </button>
        <span data-binder-target="pageIndicator" style="color:#fff;font-size:16px;min-width:120px;text-align:center;">
          Cover
        </span>
        <button data-binder-target="nextBtn" data-action="click->binder#nextSpread"
                style="background:#333;color:#fff;border:none;padding:10px 20px;border-radius:4px;cursor:pointer;font-size:14px;">
          Next &rarr;
        </button>
        <!-- Help Button -->
        <button onclick="document.getElementById('binder-help-modal').style.display='flex'"
                style="background:#333;color:#888;border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:16px;font-weight:bold;margin-left:8px;"
                title="Show keyboard shortcuts and help">
          ?
        </button>
      </div>

      <!-- Keyboard Shortcuts Hint -->
      <div style="text-align:center;margin-bottom:16px;">
        <span style="color:#555;font-size:12px;">Use <kbd style="background:#333;padding:2px 6px;border-radius:3px;color:#888;font-family:monospace;">&larr;</kbd> <kbd style="background:#333;padding:2px 6px;border-radius:3px;color:#888;font-family:monospace;">&rarr;</kbd> arrow keys to navigate</span>
      </div>
      
      <!-- Page Navigation with Status -->
      <%
        # Calculate page stats for indicators
        page_stats = binder_pages.map.with_index do |page_cards, idx|
          cards_count = page_cards.count
          owned_count = page_cards.count { |c| (c.collection_card&.quantity.to_i > 0) || (c.collection_card&.foil_quantity.to_i > 0) }
          binder_num = pages_per_binder.present? && pages_per_binder > 0 ? (idx / pages_per_binder) + 1 : 1
          {
            page_num: idx + 1,
            total: cards_count,
            owned: owned_count,
            complete: owned_count == cards_count && cards_count > 0,
            partial: owned_count > 0 && owned_count < cards_count,
            empty: owned_count == 0,
            binder: binder_num
          }
        end
        
        # Build a mapping of page numbers to spread indices (accounting for binder breaks)
        # This is needed for the page indicator buttons
        page_to_spread = {}
        current_spread_idx = 0  # Start after cover
        
        if pages_per_binder.present? && pages_per_binder > 0
          # Page 1 is on cover spread (index 0)
          page_to_spread[1] = 0
          current_spread_idx = 1
          page_num = 2
          
          while page_num <= total_binder_pages
            # Which binder is this page in?
            page_binder = ((page_num - 1) / pages_per_binder) + 1
            position_in_binder = ((page_num - 1) % pages_per_binder) + 1
            
            # Is this page starting a new binder (position 1)?
            prev_page_binder = page_num > 1 ? (((page_num - 2) / pages_per_binder) + 1) : 0
            
            if page_binder > prev_page_binder && page_num > 1
              # We crossed a binder boundary - add extra spreads for the transition
              # Back cover spread (previous binder's back + new binder's front)
              current_spread_idx += 1
              # This page is on the right side of a new spread (inside front cover on left)
              page_to_spread[page_num] = current_spread_idx
              current_spread_idx += 1
              page_num += 1
            else
              # Normal page pairing
              # Even pages go on left, odd on right of same spread
              if page_num.even?
                page_to_spread[page_num] = current_spread_idx
              else
                page_to_spread[page_num] = current_spread_idx
                current_spread_idx += 1
              end
              page_num += 1
            end
          end
        else
          # No binder breaks - simple mapping
          # Page 1 is on cover (spread 0)
          # Pages 2-3 on spread 1, 4-5 on spread 2, etc.
          page_stats.each_with_index do |stat, idx|
            page_to_spread[stat[:page_num]] = idx == 0 ? 0 : ((idx - 1) / 2) + 1
          end
        end
      %>
      <div style="display:flex;justify-content:center;align-items:center;gap:6px;margin-bottom:16px;flex-wrap:wrap;max-width:100%;padding:0 20px;">
        <!-- Cover button -->
        <button data-action="click->binder#goToSpread" 
                data-spread-index="0"
                data-binder-target="pageIndicatorDot"
                style="background:#555;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:500;transition:all 0.2s;"
                title="Cover page">
          Cover
        </button>
        
        <!-- Page buttons with status colors -->
        <% current_binder = 1 %>
        <% page_stats.each_with_index do |stat, idx| %>
          <%
            # Add binder separator when transitioning to new binder
            if stat[:binder] > current_binder
              current_binder = stat[:binder]
            end
            
            spread_idx = page_to_spread[stat[:page_num]] || 0
            
            # Color based on ownership
            if stat[:complete]
              bg_color = '#2a4a2a'
              border_color = '#4a4'
              text_color = '#6c6'
            elsif stat[:partial]
              bg_color = '#4a3a1a'
              border_color = '#c90'
              text_color = '#eb0'
            else
              bg_color = '#333'
              border_color = '#555'
              text_color = '#888'
            end
          %>
          <% if pages_per_binder.present? && pages_per_binder > 0 && stat[:page_num] > 1 && ((stat[:page_num] - 1) % pages_per_binder) == 0 %>
            <span style="color:#555;font-size:11px;padding:0 4px;">|</span>
          <% end %>
          <button data-action="click->binder#goToSpread" 
                  data-spread-index="<%= spread_idx %>"
                  data-binder-target="pageIndicatorDot"
                  style="background:<%= bg_color %>;color:<%= text_color %>;border:1px solid <%= border_color %>;min-width:32px;padding:6px 8px;border-radius:4px;cursor:pointer;font-size:11px;font-weight:600;transition:all 0.2s;"
                  title="Page <%= stat[:page_num] %>: <%= stat[:owned] %>/<%= stat[:total] %> owned<%= stat[:complete] ? ' (Complete!)' : '' %><%= total_binders > 1 ? " (Binder #{stat[:binder]})" : '' %>">
            <%= stat[:page_num] %>
          </button>
        <% end %>
      </div>
      
      <!-- Cover Spread (Page 0 - Stats + Page 1 - First cards) -->
      <div data-binder-target="spread" data-spread-type="cover" style="display:flex;gap:8px;perspective:2000px;">
        <!-- Page 0: Inside Cover with Stats -->
        <div style="flex:1;background:linear-gradient(135deg, #1a1a2a 0%, #1a1a1a 100%);border-radius:6px;padding:24px;min-height:400px;display:flex;flex-direction:column;justify-content:center;">
          <div style="text-align:center;">
            <h2 style="color:#fff;font-size:24px;font-weight:600;margin:0 0 8px 0;"><%= @card_set.name %></h2>
            <div style="color:#666;font-size:14px;margin-bottom:24px;"><%= @card_set.code.upcase %></div>
            
            <!-- Collection Progress -->
            <div style="background:#222;border-radius:8px;padding:20px;margin-bottom:20px;">
              <div style="font-size:48px;font-weight:700;color:#4f8;margin-bottom:4px;"><%= completion_pct %>%</div>
              <div style="color:#888;font-size:13px;">Collection Complete</div>
            </div>
            
            <!-- Stats Grid -->
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;text-align:center;">
              <div style="background:#222;padding:16px;border-radius:6px;">
                <div style="font-size:24px;font-weight:600;color:#fff;"><%= owned_any %></div>
                <div style="color:#888;font-size:11px;">Unique Cards</div>
              </div>
              <div style="background:#222;padding:16px;border-radius:6px;">
                <div style="font-size:24px;font-weight:600;color:#888;"><%= total_cards_in_set %></div>
                <div style="color:#888;font-size:11px;">Total in Set</div>
              </div>
              <div style="background:#222;padding:16px;border-radius:6px;">
                <div style="font-size:24px;font-weight:600;color:#6cf;"><%= total_regular %></div>
                <div style="color:#888;font-size:11px;">Regular Copies</div>
              </div>
              <div style="background:#222;padding:16px;border-radius:6px;">
                <div style="font-size:24px;font-weight:600;color:#c9f;"><%= total_foil %></div>
                <div style="color:#888;font-size:11px;">Foil Copies</div>
              </div>
            </div>
            
            <!-- Binder Info -->
            <div style="margin-top:20px;color:#666;font-size:12px;">
              <%= binder_rows %>&times;<%= binder_columns %> layout &middot; <%= total_binder_pages %> pages<%= total_binders > 1 ? " &middot; #{total_binders} binders" : '' %>
            </div>
          </div>
        </div>
        
        <!-- Page 1: First page of cards -->
        <% if first_page %>
          <% first_page_cards = first_page[:cards] %>
          <%
            page1_total = first_page_cards.count
            page1_owned = first_page_cards.count { |c| (c.collection_card&.quantity.to_i > 0) || (c.collection_card&.foil_quantity.to_i > 0) }
            page1_pct = page1_total > 0 ? (page1_owned.to_f / page1_total * 100).round(0) : 0
            page1_complete = page1_owned == page1_total && page1_total > 0
            page1_color = page1_complete ? '#4a4' : (page1_owned > 0 ? '#c90' : '#666')
          %>
          <div style="flex:1;background:#1a1a1a;border-radius:6px;padding:16px;min-height:400px;display:flex;flex-direction:column;">
            <div style="color:#666;font-size:12px;margin-bottom:12px;text-align:right;">
              Page 1<%= total_binders > 1 ? " (Binder 1)" : '' %>
            </div>
            <div style="display:grid;grid-template-columns:repeat(<%= binder_columns %>,1fr);gap:8px;flex:1;">
              <% first_page_cards.each_with_index do |card, card_index| %>
                <%= render "card_sets/binder_card_flip", card: card, card_set: (@include_subsets ? card.card_set : @card_set), position: card_index + 1 %>
              <% end %>
              <% (cards_per_page - first_page_cards.count).times do %>
                <div style="aspect-ratio:5/7;background:#111;border-radius:4px;border:1px dashed #333;"></div>
              <% end %>
            </div>
            <!-- Page Status Bar -->
            <div style="margin-top:12px;padding-top:8px;border-top:1px solid #333;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                <span style="color:<%= page1_color %>;font-size:11px;font-weight:600;">
                  <%= page1_complete ? '&#10003; Complete' : "#{page1_owned}/#{page1_total} owned" %>
                </span>
                <span style="color:#888;font-size:11px;"><%= page1_pct %>%</span>
              </div>
              <div style="height:4px;background:#333;border-radius:2px;overflow:hidden;">
                <div style="height:100%;width:<%= page1_pct %>%;background:<%= page1_color %>;border-radius:2px;transition:width 0.3s;"></div>
              </div>
            </div>
          </div>
        <% else %>
          <div style="flex:1;background:#1a1a1a;border-radius:6px;padding:16px;min-height:400px;display:flex;align-items:center;justify-content:center;">
            <div style="color:#666;text-align:center;">
              <div style="font-size:48px;margin-bottom:12px;">&#128235;</div>
              <div>No cards in this set yet</div>
            </div>
          </div>
        <% end %>
      </div>
      
      <!-- Remaining Spreads -->
      <% spread_pages.each_with_index do |spread_pair, spread_index| %>
        <div data-binder-target="spread" style="display:none;gap:8px;perspective:2000px;">
          <% spread_pair.each_with_index do |page_data, page_in_spread| %>
            <% if page_data[:type] == :cards %>
              <%
                page_cards = page_data[:cards]
                page_num = page_data[:page_num]
                page_binder = page_data[:binder]
                pg_total = page_cards.count
                pg_owned = page_cards.count { |c| (c.collection_card&.quantity.to_i > 0) || (c.collection_card&.foil_quantity.to_i > 0) }
                pg_pct = pg_total > 0 ? (pg_owned.to_f / pg_total * 100).round(0) : 0
                pg_complete = pg_owned == pg_total && pg_total > 0
                pg_color = pg_complete ? '#4a4' : (pg_owned > 0 ? '#c90' : '#666')
              %>
              <!-- Page <%= page_num %> (<%= page_in_spread == 0 ? 'Left' : 'Right' %>) -->
              <div style="flex:1;background:#1a1a1a;border-radius:6px;padding:16px;min-height:400px;display:flex;flex-direction:column;">
                <div style="color:#666;font-size:12px;margin-bottom:12px;text-align:<%= page_in_spread == 0 ? 'left' : 'right' %>;">
                  Page <%= page_num %><%= total_binders > 1 ? " (Binder #{page_binder})" : '' %>
                </div>
                <div style="display:grid;grid-template-columns:repeat(<%= binder_columns %>,1fr);gap:8px;flex:1;">
                  <% page_cards.each_with_index do |card, card_index| %>
                    <%= render "card_sets/binder_card_flip", card: card, card_set: (@include_subsets ? card.card_set : @card_set), position: card_index + 1 %>
                  <% end %>
                  <% (cards_per_page - page_cards.count).times do %>
                    <div style="aspect-ratio:5/7;background:#111;border-radius:4px;border:1px dashed #333;"></div>
                  <% end %>
                </div>
                <!-- Page Status Bar -->
                <div style="margin-top:12px;padding-top:8px;border-top:1px solid #333;">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                    <span style="color:<%= pg_color %>;font-size:11px;font-weight:600;">
                      <%= pg_complete ? '&#10003; Complete' : "#{pg_owned}/#{pg_total} owned" %>
                    </span>
                    <span style="color:#888;font-size:11px;"><%= pg_pct %>%</span>
                  </div>
                  <div style="height:4px;background:#333;border-radius:2px;overflow:hidden;">
                    <div style="height:100%;width:<%= pg_pct %>%;background:<%= pg_color %>;border-radius:2px;transition:width 0.3s;"></div>
                  </div>
                </div>
              </div>
            <% elsif page_data[:type] == :binder_end %>
              <!-- Back Cover of Binder <%= page_data[:binder] %> -->
              <div style="flex:1;background:linear-gradient(135deg, #2a1a1a 0%, #1a1a1a 100%);border-radius:6px;padding:24px;min-height:400px;display:flex;flex-direction:column;justify-content:center;">
                <div style="text-align:center;">
                  <div style="font-size:64px;margin-bottom:16px;opacity:0.3;">&#128218;</div>
                  <div style="color:#666;font-size:16px;font-weight:500;">End of Binder <%= page_data[:binder] %></div>
                  <div style="color:#444;font-size:12px;margin-top:8px;">Back Cover</div>
                </div>
              </div>
            <% elsif page_data[:type] == :binder_start %>
              <!-- Front Cover of Binder <%= page_data[:binder] %> -->
              <div style="flex:1;background:linear-gradient(135deg, #1a2a1a 0%, #1a1a1a 100%);border-radius:6px;padding:24px;min-height:400px;display:flex;flex-direction:column;justify-content:center;">
                <div style="text-align:center;">
                  <div style="font-size:64px;margin-bottom:16px;opacity:0.3;">&#128214;</div>
                  <div style="color:#666;font-size:16px;font-weight:500;">Binder <%= page_data[:binder] %></div>
                  <div style="color:#444;font-size:12px;margin-top:8px;">Inside Front Cover</div>
                </div>
              </div>
            <% end %>
          <% end %>
          
          <% # Add empty right page if spread has only one page %>
          <% if spread_pair.count == 1 && spread_pair[0][:type] == :cards %>
            <div style="flex:1;background:#1a1a1a;border-radius:6px;padding:16px;min-height:400px;display:flex;flex-direction:column;">
              <div style="color:#666;font-size:12px;margin-bottom:12px;text-align:right;">
                Empty
              </div>
              <div style="display:grid;grid-template-columns:repeat(<%= binder_columns %>,1fr);gap:8px;flex:1;">
                <% cards_per_page.times do %>
                  <div style="aspect-ratio:5/7;background:#111;border-radius:4px;border:1px dashed #333;"></div>
                <% end %>
              </div>
              <!-- Empty Page Status Bar -->
              <div style="margin-top:12px;padding-top:8px;border-top:1px solid #333;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                  <span style="color:#666;font-size:11px;font-weight:600;">Empty page</span>
                  <span style="color:#888;font-size:11px;">-</span>
                </div>
                <div style="height:4px;background:#333;border-radius:2px;overflow:hidden;">
                  <div style="height:100%;width:0%;background:#666;border-radius:2px;"></div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>

    </div>

    <!-- Help Modal -->
    <div id="binder-help-modal"
         onclick="if(event.target===this)this.style.display='none'"
         style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:10000;align-items:center;justify-content:center;padding:20px;">
      <div style="background:#1a1a1a;border:1px solid #333;border-radius:8px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #333;">
          <h3 style="margin:0;color:#fff;font-size:18px;">Binder View Help</h3>
          <button onclick="document.getElementById('binder-help-modal').style.display='none'"
                  style="background:none;border:none;color:#888;font-size:24px;cursor:pointer;padding:0;line-height:1;">&times;</button>
        </div>
        <div style="padding:20px;">
          <!-- Keyboard Shortcuts -->
          <div style="margin-bottom:24px;">
            <h4 style="color:#4cf;font-size:14px;margin:0 0 12px 0;">Keyboard Shortcuts</h4>
            <div style="display:grid;grid-template-columns:auto 1fr;gap:8px 16px;font-size:13px;">
              <kbd style="background:#333;padding:4px 8px;border-radius:3px;color:#fff;font-family:monospace;">&larr;</kbd>
              <span style="color:#ccc;">Previous spread (page pair)</span>
              <kbd style="background:#333;padding:4px 8px;border-radius:3px;color:#fff;font-family:monospace;">&rarr;</kbd>
              <span style="color:#ccc;">Next spread (page pair)</span>
            </div>
          </div>

          <!-- Card Controls -->
          <div style="margin-bottom:24px;">
            <h4 style="color:#4cf;font-size:14px;margin:0 0 12px 0;">Card Controls</h4>
            <div style="font-size:13px;color:#ccc;line-height:1.8;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <span style="background:#333;padding:2px 6px;border-radius:3px;font-size:11px;">&#9881;</span>
                <span><strong>Edit button</strong> - Click to open quantity editor for the card</span>
              </div>
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <span style="background:#333;padding:2px 6px;border-radius:3px;font-size:11px;">&#8644;</span>
                <span><strong>Flip button</strong> - For double-faced cards, flip between front and back</span>
              </div>
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <span style="background:#28a745;padding:2px 6px;border-radius:3px;font-size:11px;color:#fff;">&#x2193;</span>
                <span><strong>Download button</strong> - Download missing card image from Scryfall</span>
              </div>
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <span style="background:#d4a017;padding:2px 6px;border-radius:3px;font-size:10px;font-weight:bold;color:#1a1a1a;">NEW</span>
                <span><strong>Placement badge</strong> - Click to mark card as placed in your physical binder</span>
              </div>
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <span style="background:#1a3a1a;padding:2px 6px;border-radius:3px;font-size:11px;color:#4f8;">x2</span>
                <span><strong>Quantity badge</strong> - Shows how many regular copies you own</span>
              </div>
              <div style="display:flex;align-items:center;gap:8px;">
                <span style="background:linear-gradient(135deg, #2a2a3a 0%, #1a1a2a 100%);padding:2px 6px;border-radius:3px;font-size:11px;color:#c9f;">x1</span>
                <span><strong>Foil badge</strong> - Shows how many foil copies you own</span>
              </div>
            </div>
          </div>

          <!-- Page Indicators -->
          <div style="margin-bottom:24px;">
            <h4 style="color:#4cf;font-size:14px;margin:0 0 12px 0;">Page Navigation</h4>
            <div style="font-size:13px;color:#ccc;line-height:1.8;">
              <p style="margin:0 0 8px 0;">Click any page number button to jump directly to that page.</p>
              <div style="display:flex;gap:12px;flex-wrap:wrap;">
                <div style="display:flex;align-items:center;gap:6px;">
                  <span style="background:#2a4a2a;border:1px solid #4a4;padding:4px 8px;border-radius:4px;font-size:11px;color:#6c6;">5</span>
                  <span>Complete page</span>
                </div>
                <div style="display:flex;align-items:center;gap:6px;">
                  <span style="background:#4a3a1a;border:1px solid #c90;padding:4px 8px;border-radius:4px;font-size:11px;color:#eb0;">12</span>
                  <span>Partial page</span>
                </div>
                <div style="display:flex;align-items:center;gap:6px;">
                  <span style="background:#333;border:1px solid #555;padding:4px 8px;border-radius:4px;font-size:11px;color:#888;">23</span>
                  <span>Empty page</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Binder Settings -->
          <div style="margin-bottom:24px;">
            <h4 style="color:#4cf;font-size:14px;margin:0 0 12px 0;">Binder Settings</h4>
            <div style="font-size:13px;color:#ccc;line-height:1.6;">
              <p style="margin:0 0 8px 0;">Click the <span style="background:#333;padding:2px 6px;border-radius:3px;">&#9881;</span> gear icon above the binder to access settings:</p>
              <ul style="margin:0;padding-left:20px;color:#999;">
                <li><strong>Rows/Columns</strong> - Match your physical binder layout</li>
                <li><strong>Sort by</strong> - How cards are ordered (number, name, rarity, etc.)</li>
                <li><strong>Pages/Binder</strong> - Set page count to simulate multiple binders</li>
                <li><strong>Include Related</strong> - Show cards from related sets (tokens, promos)</li>
              </ul>
            </div>
          </div>

          <!-- Card Appearance -->
          <div>
            <h4 style="color:#4cf;font-size:14px;margin:0 0 12px 0;">Card Appearance</h4>
            <div style="font-size:13px;color:#ccc;line-height:1.6;">
              <ul style="margin:0;padding-left:20px;color:#999;">
                <li><strong>Bright cards</strong> - Cards you own</li>
                <li><strong>Dimmed/grayscale cards</strong> - Cards you don't own (hover to see full image)</li>
                <li><strong>Card number</strong> - Shown at bottom-left of each card</li>
                <li><strong>Position number</strong> - Shown at bottom-right (#1, #2, etc. on the page)</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<div data-controller="set-progress" 
     data-set-progress-set-id-value="<%= @card_set.id %>"
     data-set-progress-is-downloading-value="<%= @card_set.downloading? || @card_set.pending? %>"></div>
